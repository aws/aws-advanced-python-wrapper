# Using the AWS Advanced Python Driver

The AWS Advanced Python Driver leverages community Python drivers and enables support of AWS and Aurora functionalities.
Currently, [Psycopg](https://github.com/psycopg/psycopg) and [MySQL Connector/Python](https://github.com/mysql/mysql-connector-python) are supported.

## Using the AWS Advanced Python Driver with plain RDS databases

It is possible to use the AWS Advanced Python Driver with plain RDS databases, but individual features may or may not be compatible. For example, failover handling and enhanced failure monitoring are not compatible with plain RDS databases and the relevant plugins must be disabled. Plugins can be enabled or disabled as seen in the [Connection Plugin Manager Parameters](#connection-plugin-manager-parameters) section. Please note that some plugins have been enabled by default. Plugin compatibility can be verified in the [plugins table](#list-of-available-plugins).

## AWS Advanced Python Driver Parameters

These parameters are applicable to any instance of the AWS Advanced Python Driver.

| Parameter                     | Description                                                                                                                                                                                                                                                                                                                                                                                 | Required | Default Value |
|-------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|---------------|
| wrapper_dialect               | A unique identifier for the supported database dialect.                                                                                                                                                                                                                                                                                                                                     | False    | None          |
| wrapper_driver_dialect | A unique identifier for the target driver dialect.                                                                                                                                                                                                                                                                                                                                          | False    | None          |
| auxiliary_query_timeout_sec   | Network timeout, in seconds, used for auxiliary queries to the database. This timeout applies to queries executed by the wrapper driver to gain info about the connected database. It does not apply to queries requested by the driver client.                                                                                                                                             | False    | 5             |
| topology_refresh_ms           | Cluster topology refresh rate in milliseconds. The cached topology for the cluster will be invalidated after the specified time, after which it will be updated during the next interaction with the connection.                                                                                                                                                                            | False    | 30000         |
| cluster_id                    | A unique identifier for the cluster. Connections with the same cluster id share a cluster topology cache. If unspecified, a cluster id is automatically created for AWS RDS clusters.                                                                                                                                                                                                       | False    | None          |
| cluster_instance_host_pattern | The cluster instance DNS pattern that will be used to build a complete instance endpoint. A "?" character in this pattern should be used as a placeholder for cluster instance names. This pattern is required to be specified for IP address or custom domain connections to AWS RDS clusters. Otherwise, if unspecified, the  pattern will be automatically created for AWS RDS clusters. | False    | 30000         |

### Network Timeouts
> TODO

| Parameter                     | Description                                                                                                                                                                                                                                                                                                                                                                                 | Required | Default Value |
|-------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|---------------|
| connect_timeout               | Max number of seconds to wait for a connection to be established before timing out.                                                                                                                                                                                                                                                                                                         | False    | None          |
| socket_timeout                | Max number of seconds to wait for a SQL query to complete before timing out.                                                                                                                                                                                                                                                                                                                | False    | None          |
| tcp_keepalive                 | Enable TCP keepalive functionality.                                                                                                                                                                                                                                                                                                                                                         | False    | None          |
| tcp_keepalive_time            | Number of seconds to wait before sending an initial keepalive probe.                                                                                                                                                                                                                                                                                                                        | False    | None          |
| tcp_keepalive_interval        | Number of seconds to wait before sending additional keepalive probes after the initial probe has been sent.                                                                                                                                                                                                                                                                                 | False    | None          |
| tcp_keepalive_probes          | Number of keepalive probes to send before concluding that the connection is invalid.                                                                                                                                                                                                                                                                                                        | False    | None          |

## Plugins

The AWS Advanced Python Driver uses plugins to execute database API calls. You can think of a plugin as an extensible code module that adds extra logic around any database API calls. The AWS Advanced Python Driver has a number of [built-in plugins](#list-of-available-plugins) available for use. 

Plugins are loaded and managed through the Connection Plugin Manager and may be identified by a `str` name in the form of plugin code.

### Connection Plugin Manager Parameters

| Parameter         | Value | Required | Description                                                                                                                                                                   | Default Value                          |
|-------------------|-------|----------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------|
| `plugins`         | `str` | No       | Comma separated list of connection plugin codes. <br><br>Example: `failover,efm`                                                                                              | `auroraConnectionTracker,failover,efm` | 
| `auto_sort_wrapper_plugin_order` | `str` | No       | Certain plugins require a specific plugin chain ordering to function correctly. When enabled, this property automatically sorts the requested plugins into the correct order. | `True`                                   |
| `profile_name` | `str` | No       | Driver configuration profile name. An alternative way of setting plugin codes, the driver profile can be set with this parameter. <br><br> Example: See [below](#configuration-profiles). | `None`                                 |

### Configuration Profiles
An alternative way of loading plugins is to use a configuration profile. You can create custom configuration profiles that specify which plugins the AWS Python Driver should load. After creating the profile, set the [`profile_name`](#connection-plugin-manager-parameters) parameter to the name of the created profile.
Although you can use this method of loading plugins, this method will most often be used by those who require custom plugins that cannot be loaded with the [`plugins`](#connection-plugin-manager-parameters) parameter.
The following example creates and sets a configuration profile:

```python
properties = Properties({"profile_name": "test_profile"})
DriverConfigurationProfiles.add_or_replace_profile(
    "test_profile", 
    [FailoverPluginFactory(), HostMonitoringPluginFactory(), IamAuthPluginFactory()])
```

### List of Available Plugins

The AWS Advanced Python Driver has several built-in plugins that are available to use. Please visit the individual plugin page for more details.

| Plugin name                                                                                  | Plugin Code                 | Database Compatibility | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | Additional Required Dependencies                                     |
|----------------------------------------------------------------------------------------------|-----------------------------|------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------|
| [Failover Connection Plugin](./using-plugins/UsingTheFailoverPlugin.md)                      | `failover`                  | Aurora                 | Enables the failover functionality supported by Amazon Aurora clusters. Prevents opening a wrong connection to an old writer host dues to stale DNS after failover event. This plugin is enabled by default.                                                                                                                                                                                                                                                                                                      | None                                                                 |                             
| [Host Monitoring Connection Plugin](./using-plugins/UsingTheHostMonitoringPlugin.md)         | `host_monitoring`           | Aurora                 | Enables enhanced host connection failure monitoring, allowing faster failure detection rates. This plugin is enabled by default.                                                                                                                                                                                                                                                                                                                                                                                  | None                                                                 |
| [IAM Authentication Connection Plugin](./using-plugins/UsingTheIamAuthenticationPlugin.md)   | `iam`                       | Any database           | Enables users to connect to their Amazon Aurora clusters using AWS Identity and Access Management (IAM).                                                                                                                                                                                                                                                                                                                                                                                                          | [Boto3 - AWS SDK for Python](https://aws.amazon.com/sdk-for-python/) |
| [AWS Secrets Manager Connection Plugin](./using-plugins/UsingTheAwsSecretsManagerPlugin.md)  | `aws_secrets_manager`       | Any database           | Enables fetching database credentials from the AWS Secrets Manager service.                                                                                                                                                                                                                                                                                                                                                                                                                                       | [Boto3 - AWS SDK for Python](https://aws.amazon.com/sdk-for-python/) |
| Aurora Stale DNS Plugin                                                                      | `stale_dns`                 | Aurora                 | Prevents incorrectly opening a new connection to an old writer host when DNS records have not yet updated after a recent failover event. <br><br> :warning:**Note:** Contrary to `failover` plugin, `stale_dns` plugin doesn't implement failover support itself. It helps to eliminate opening wrong connections to an old writer host after cluster failover is completed. <br><br> :warning:**Note:** This logic is already included in `failover` plugin so you can omit using both plugins at the same time. | None                                                                 |
| [Aurora Connection Tracker Plugin](./using-plugins/UsingTheAuroraConnectionTrackerPlugin.md) | `aurora_connection_tracker` | Aurora                 | Tracks all the opened connections. In the event of a cluster failover, the plugin will close all the impacted connections to the host. This plugin is enabled by default.                                                                                                                                                                                                                                                                                                                                         | None                                                                 |
| [Read Write Splitting Plugin](./using-plugins/UsingTheReadWriteSplittingPlugin.md)           | `read_write_splitting`      | Aurora                 | Enables read write splitting functionality where users can switch between database reader and writer instances.                                                                                                                                                                                                                                                                                                                                                                                                   | None                                                                 |

In addition to the built-in plugins, you can also create custom plugins more suitable for your needs.
For more information, see [Custom Plugins](../development-guide/LoadablePlugins.md#using-custom-plugins).
